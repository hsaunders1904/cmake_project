#!groovy

node {
  withCredentials([string(credentialsId: 'cmake_project_Trigger_Token',
                   variable: 'trigger_token')]) {
    properties([
      pipelineTriggers([[
        $class: 'GenericTrigger',
        genericVariables: [
          [key: 'ACTION', value: '\$.action'],
          [key: 'BASE_COMMIT_REF', value: '\$.pull_request.base.ref'],
          [key: 'COMMIT_SHA', value: '\$.pull_request.head.sha'],
          [key: 'PR_NUMBER', value: '\$.pull_request.number', defaultValue: ''],
          [key: 'PR_URL', value: '\$.pull_request.html_url', defaultValue: '']
        ],
        token: trigger_token,
        causeString: 'Triggered PR-$PR_NUMBER $PR_URL',
        printContributedVariables: false,
        printPostContent: false,
        silentResponse: false,
        regexpFilterText: '$ACTION',
        regexpFilterExpression: '(opened|synchronize)'
      ]])
    ])
  }
}

pipeline {
  agent any

  stages {

    stage('Checkout') {
      steps {
        checkout([
          $class: 'GitSCM',
          branches: [[name: '${COMMIT_SHA}']],
          doGenerateSubmoduleConfigurations: false,
          extensions: [[
            $class: 'PreBuildMerge',
            options: [
              mergeRemote: 'origin',
              mergeTarget: '${BASE_COMMIT_REF}']]],
          submoduleCfg: [],
          userRemoteConfigs: [[
            name: 'origin',
            url: 'https://github.com/hsaunders1904/cmake_project.git'
          ]]
        ])
      }
    }

    stage('Build') {
      steps {
        sh '''
          echo "Commit sha: ${COMMIT_SHA}"
          echo "Commit sha: ${BASE_COMMIT_SHA}"
          cd build/
          cmake .. -G "Unix Makefiles"
          cmake --build .
        '''
      }
    }

    stage('Test') {
      steps {
        sh '''
          cd build/
          ctest --output-on-failure -T test --no-compress-output || /usr/bin/true
        '''
        xunit (
          testTimeMargin: '3000',
          thresholdMode: 1,
          thresholds: [
            skipped(failureThreshold: '0'),
            failed(failureThreshold: '0')
          ],
          tools: [
            CTest(
              pattern: 'build/Testing/**/*.xml',
              deleteOutputFiles: true,
              failIfNotNew: true,
              skipNoTestFiles: false,
              stopProcessingIfError: true
            )
          ]
        )
      }
    }
  }

  post {
    cleanup {
      deleteDir()
    }
  }
}
